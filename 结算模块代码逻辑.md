#结算模块代码逻辑

[TOC]

###描述
结算模块所有基础数据全部使用job自动生成，有增量和全量job，日汇总和付款建议的job都是在凌晨之后（T+1）执行。

###结算中心依赖的其他模块

+ 支付模块：提供第三方账务数据，用于对账。
+ 用户模块：商家提供账期、费率等信息

   账期：运营输入 1、5、10、15、30五类（可以灵活配置）
   
   费率：三个地方可以设置 1、shopExtra 2、行业 3、二级类目（可扩展到商品级  别）
   
+ 交易模块：订单相关信息

###job清单
+ job 拉取第三方账务记录(增量，全量)
+ job生成支付渠道汇总明细（增量，全量）
+ job生成支付渠道日汇总
+ job 生成账务明细，及账务记录
+ job 处理账务记录
+ job 对账
+ job 生成商家日汇总
+ job 生成平台日汇总
+ job生成付款建议
+ job生成平台优惠券日汇总
+ job生成售后退款账务(增量，全量)
+ job售后对账

###job说明
+ job 拉取第三方账务记录(增量，全量)
	**类名：**AlipayTransLoadJob
	
	**方法名：**增量：loadByHoursInterval 全量：loadByDay
	
	**执行时机：**增量：1小时全量：凌晨1点
	
	**描述：** 该方法主动拉取支付的账务数据，把拉取到的账务数据保存到AlipayTrans中。



+ job生成支付渠道汇总明细（增量，全量）
	**类名：**SettlementJobs
	
	**方法名：**增量：generateChannelSummaryDetail 全量：dumpGenerateChannelSummaryDetail
	
	**执行时机：**增量：5分钟 全量：凌晨2点
	
	**描述：** 该方法主动拉取支付模块PayChannel中的有效数据生成明细记录，
	区分正向和逆向交易，正向：paidAt>=startAt and paidAt< endAt 逆向：refundAt>=refundStartAt and refundAt<refundEndAt，生成明细记录时需要获取支付渠道对应的别名，即alipay、wapalipay都属于alipay，所以别名为alipay便于支付渠道日汇总时按照支付渠道分组。对于逆向明细记录要区分是拒收退款还是售后退款可根据退款单来区分。


+ job生成支付渠道日汇总
	**类名：**SettlementJobs
	
	**方法名：**channelDailySummary
	
	**执行时机：**凌晨3点
	
	**描述：** 该方法主动去支付渠道日汇总明细在T+1时根据支付渠道分组汇总出T日各个支付渠道的净交易金额。


+ job 生成账务明细，及账务记录
	**类名：**SettlementJobs
	
	**方法名：**增量：generateSettlement 全量：dumpGenerateSettlement
	
	**执行时机：**增量：5分钟 全量：凌晨1点
	
	**描述：** 该方法主动拉取OrderTrack中的有效数据生成账务记录，限制条件为：paidAt>=startAt and paidAt< endAt AND pay_type =1(在线支付) AND need_settle=true，账务的生成逻辑是有一个拦截器链组成，settlementInterceptor账务记录链、normalInterceptor正向支付金额账务明细链、saleInterceptor营销支出账务明细链、shipFeeInterceptor运费账务明细链。

+ job 处理账务记录
	**类名：**SettlementJobs
	
	**方法名：**handleSettlement
	
	**执行时机：**每5分钟 
	
	**描述：** 该方法处理账务记录中未完成的数据，完成各个状态的流转和对应数据的回填，主要由更新订单信息、更新对账状态和手续费、更新平台佣金，最后标记账务记录为完成状态，对账状态是根据判断该订单相关的所有支付渠道日汇总明细记录是否都已全部标记为对账完成，如果是则为已对账。


+ job 对账
	**类名：**SettlementJobs
	
	**方法名：**check
	
	**执行时机：**每5分钟 
	
	**描述：** 该方法处理支付渠道日汇总明细汇总未对账的数据，用汇总明细中的第三方交易流水号去第三方账务记录中查找对应的记录，比较双方的金额是否相等，如果相等则标记为已完成。

+ job 生成商家日汇总
	**类名：**SettlementJobs
	
	**方法名：**summary
	
	**执行时机：**每天凌晨2点
	
	**描述：** 该方法在T+1时统计出T日账务记录（已完成状态）中各个商家的各项金额的收支情况。


+ job 生成平台日汇总
	**类名：**SettlementJobs
	
	**方法名：**platformSummary
	
	**执行时机：**每天凌晨2点
	
	**描述：** 该方法在T+1时统计出T日账务记录（已完成状态）中整个平台的各项金额的收支情况。


+ job生成付款建议
	**类名：**SettlementJobs
	
	**方法名：**generatePayAdvise
	
	**执行时机：**每天凌晨3点
	
	**描述：** 生成给商家打款的付款建议，该表记录的当前账期内要给商家打款的金额，付款建议有两种类型，货款和平台优惠券，平台优惠券需要开发票，只要开过发票的付款建议才可以打款,由商家填写发票信息，运营人员进行审核操作，审核通过后即可标记打款。账期分为1、5、10、15、30五类，货款的数据来源于三个地方，1、账务记录2、运费/奖罚/扣还3、售后退款账务。平台优惠券的数据来源于 1、账务记录 2、售后退款账务
	**注意：**付款建议不取决于账期开始时间与结束时间，每次job执行时判断当天是否是在账期内，如果是则汇总目前时间为止之前没有生成过付款建议且是已完成的账务记录来生成付款建议。
	
	**计算公式**
	**货款：**
	
	商家打款金额 = 支付金额（正数）+平台佣金（负数）+奖惩 - 售后退款金额（正数）+平台抽佣（正数）
	
	**平台优惠券：**
	
	商家打款金额 = 平台优惠券 - 平台优惠券（妥投退款）
	
	**平台佣金**
	
	平台佣金 = （支付金额+平台优惠券）*费率


+ job生成平台优惠券日汇总
	**类名：**SettlementJobs
	
	**方法名：**couponSummary
	
	**执行时机：**每5分钟
	
	**描述：** 该方法在T+1时统计出T日账务明细记录中平台优惠券的支出情况。


+ job生成售后退款账务(增量，全量)
	**类名：**SettlementJobs
	
	**方法名：**增量：generateAfterSalesSettlement 全量：dumpGenerateAfterSalesSettlement
	
	**执行时机：**增量 ：每5分钟 全量：每天凌晨2点
	
	**描述：** 该方法主动拉取orderItemRefundTrack中有效的记录来生成对应的售后账务。查询条件为 类型为售后且已完成的。

+ job售后对账
	**类名：**SettlementJobs
	
	**方法名：**checkAfterSales
	
	**执行时机：**每5分钟
	
	**描述：** 该方法查询出所有未对账的记录去支付渠道日汇总明细中判断相关的记录是否是已对账，如果是则标记为已对账。

